## ðŸŸ£ Real-world Scenarios

### Question 51: Find users who made purchases on consecutive days.

**Answer:**
We can use the `LEAD()` or `LAG()` window function to compare the date of the current purchase with the next/previous purchase for the same user.

**Query:**
```sql
WITH OrderedPurchases AS (
    SELECT 
        UserID, 
        PurchaseDate, 
        LAG(PurchaseDate) OVER (PARTITION BY UserID ORDER BY PurchaseDate) as PrevDate
    FROM Purchases
)
SELECT DISTINCT UserID
FROM OrderedPurchases
WHERE DATEDIFF(day, PrevDate, PurchaseDate) = 1;
```

---

### Question 52: Write a query to find repeat customers.

**Answer:**
A repeat customer is someone who has made more than one purchase.

**Query:**
```sql
SELECT UserID, COUNT(OrderID) as PurchaseCount
FROM Orders
GROUP BY UserID
HAVING COUNT(OrderID) > 1;
```

---

### Question 53: Find top 3 selling products in each category.

**Answer:**
Use `DENSE_RANK()` (or `ROW_NUMBER()`) partitioned by category.

**Query:**
```sql
WITH RankedProducts AS (
    SELECT 
        Category, 
        ProductName, 
        TotalSales,
        DENSE_RANK() OVER (PARTITION BY Category ORDER BY TotalSales DESC) as Rank
    FROM ProductSales
)
SELECT * 
FROM RankedProducts 
WHERE Rank <= 3;
```

---

### Question 54: Calculate customer lifetime value (CLV).

**Answer:**
CLV is generally the total revenue generated by a customer.

**Query:**
```sql
SELECT 
    CustomerID, 
    SUM(TotalAmount) as LifetimeValue
FROM Orders
GROUP BY CustomerID
ORDER BY LifetimeValue DESC;
```

---

### Question 55: Track changes in customer status using SQL (SCD Type 2).

**Answer:**
Slowly Changing Dimensions (Type 2) keep history by adding new rows for updates.
Requires columns: `ValidFrom`, `ValidTo`, `IsCurrent`.

**Logic (Insert new record):**
1.  Update the old record: Set `ValidTo` = CurrentDate, `IsCurrent` = False.
2.  Insert new record: `ValidFrom` = CurrentDate, `ValidTo` = NULL (or future date), `IsCurrent` = True.

**Query (Viewing History):**
```sql
SELECT CustomerID, Status, ValidFrom, ValidTo
FROM CustomerHistory
WHERE CustomerID = 123
ORDER BY ValidFrom;
```

---

### Question 56: Identify users with declining monthly usage.

**Answer:**
Use `LAG()` to compare current month's usage with previous month.

**Query:**
```sql
WITH MonthlyUsage AS (
    SELECT 
        UserID, 
        Month, 
        UsageCount,
        LAG(UsageCount) OVER (PARTITION BY UserID ORDER BY Month) as PrevMonthUsage
    FROM UserActivity
)
SELECT UserID
FROM MonthlyUsage
WHERE UsageCount < PrevMonthUsage;
```

---

### Question 57: Write a query to calculate retention rate month over month.

**Answer:**
Retention Rate = (Users in Month 2 who were also in Month 1) / (Total Users in Month 1).

**Query (simplified):**
```sql
WITH MonthlyUsers AS (
    SELECT DISTINCT UserID, DATE_TRUNC('month', ActivityDate) as Month
    FROM Logins
)
SELECT 
    CurrentMonth.Month,
    COUNT(DISTINCT CurrentMonth.UserID) as RetainedUsers,
    COUNT(DISTINCT PrevMonth.UserID) as PreviousUsers,
    (COUNT(DISTINCT CurrentMonth.UserID)::FLOAT / COUNT(DISTINCT PrevMonth.UserID)) * 100 as RetentionRate
FROM MonthlyUsers CurrentMonth
JOIN MonthlyUsers PrevMonth 
  ON CurrentMonth.UserID = PrevMonth.UserID 
  AND CurrentMonth.Month = PrevMonth.Month + INTERVAL '1 month'
GROUP BY CurrentMonth.Month;
```

---

### Question 58: Get average time between user signup and first purchase.

**Answer:**
Join Users and Orders table, calculate simple difference.

**Query:**
```sql
SELECT AVG(DATEDIFF(day, U.SignupDate, O.FirstOrderDate)) as AvgDays
FROM Users U
JOIN (
    SELECT UserID, MIN(OrderDate) as FirstOrderDate
    FROM Orders
    GROUP BY UserID
) O ON U.UserID = O.UserID;
```

---

### Question 59: Segment users based on activity (e.g., high, medium, low).

**Answer:**
Use `CASE` statement based on activity count.

**Query:**
```sql
SELECT 
    UserID,
    COUNT(OrderID) as Orders,
    CASE 
        WHEN COUNT(OrderID) > 50 THEN 'High'
        WHEN COUNT(OrderID) BETWEEN 10 AND 50 THEN 'Medium'
        ELSE 'Low'
    END as Segment
FROM Orders
GROUP BY UserID;
```

---

### Question 60: Detect anomalies in daily transaction volumes.

**Answer:**
Compare daily volume against a moving average (e.g., past 7 days). Identify days with > 2x deviation.

**Query:**
```sql
WITH DailyStats AS (
    SELECT 
        TxnDate, 
        COUNT(*) as Volume,
        AVG(COUNT(*)) OVER (ORDER BY TxnDate ROWS BETWEEN 7 PRECEDING AND 1 PRECEDING) as MovingAvg
    FROM Transactions
    GROUP BY TxnDate
)
SELECT * 
FROM DailyStats 
WHERE Volume > (MovingAvg * 2); -- 200% spike
```

---

## ðŸŸ¤ Date & Time Manipulations

### Question 61: How do you extract year/month/day from a date?

**Answer:**
**Standard SQL / PostgreSQL:**
```sql
SELECT EXTRACT(YEAR FROM OrderDate), EXTRACT(MONTH FROM OrderDate)
FROM Orders;
```
**SQL Server:**
```sql
SELECT YEAR(OrderDate), MONTH(OrderDate), DAY(OrderDate)
FROM Orders;
```

---

### Question 62: Write a query to get the last day of each month.

**Answer:**
**PostgreSQL:**
```sql
SELECT (DATE_TRUNC('month', NOW()) + INTERVAL '1 month - 1 day')::DATE;
```
**SQL Server:**
```sql
SELECT EOMONTH(GETDATE());
```

---

### Question 63: Find the number of working days between two dates.

**Answer:**
Usually requires excluding Saturdays/Sundays.
```sql
SELECT 
   COUNT(*)
FROM CalendarTable  -- Hypothetical calendar table used in finding business days
WHERE DateValue BETWEEN '2023-01-01' AND '2023-01-31'
  AND IsWeekend = 0;
```
Without a calendar table, it involves complex math using `DATEDIFF` and modulo 7.

---

### Question 64: Calculate age from date of birth.

**Answer:**
**PostgreSQL:**
```sql
SELECT AGE(TIMESTAMP '2023-10-01', TIMESTAMP '1990-01-01');
```
**SQL Server:**
```sql
SELECT DATEDIFF(YEAR, DOB, GETDATE()); -- Simple Calc
```

---

### Question 65: How do you handle time zones in SQL?

**Answer:**
Always store dates in UTC. Convert to local time at query time.
**PostgreSQL:**
```sql
SELECT NOW() AT TIME ZONE 'UTC';
SELECT OrderDate AT TIME ZONE 'America/New_York';
```

---

### Question 66: Write a query to get users who signed up in the past 7 days.

**Answer:**
```sql
-- PostgreSQL / MySQL
SELECT * FROM Users 
WHERE SignupDate >= CURRENT_DATE - INTERVAL '7 days';

-- SQL Server
SELECT * FROM Users 
WHERE SignupDate >= DATEADD(day, -7, GETDATE());
```

---

### Question 67: Get the number of orders by week.

**Answer:**
```sql
SELECT 
    DATE_TRUNC('week', OrderDate) as WeekStart, -- PostgreSQL
    COUNT(*) 
FROM Orders
GROUP BY 1;
```

---

### Question 68: How do you truncate a date to the start of the month?

**Answer:**
**PostgreSQL:** `DATE_TRUNC('month', OrderDate)`
**SQL Server:** `DATEFROMPARTS(YEAR(Date), MONTH(Date), 1)`

---

### Question 69: How to calculate time difference in hours between two timestamps?

**Answer:**
**PostgreSQL:**
```sql
SELECT EXTRACT(EPOCH FROM (EndTimestamp - StartTimestamp)) / 3600;
```
**SQL Server:**
```sql
SELECT DATEDIFF(HOUR, StartTimestamp, EndTimestamp);
```

---

### Question 70: Write a query to get users inactive for more than 30 days.

**Answer:**
```sql
SELECT UserID 
FROM UserLogins 
GROUP BY UserID 
HAVING MAX(LoginDate) < CURRENT_DATE - INTERVAL '30 days';
```

---

## ðŸŸ§ Data Cleaning & Transformation

### Question 71: How do you remove duplicates in a table?

**Answer:**
**Method 1: Using CTE (Delete from same table)**
```sql
WITH CTE AS (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY ID ORDER BY CreatedAt DESC) as rn
    FROM Users
)
DELETE FROM CTE WHERE rn > 1;
```

**Method 2: Create new table with DISTINCT**
```sql
CREATE TABLE Users_Clean AS SELECT DISTINCT * FROM Users;
```

---

### Question 72: How do you handle NULLs in aggregate functions?

**Answer:**
Aggregate functions (SUM, AVG, MIN, MAX) **ignore NULLs** automatically. `COUNT(*)` counts rows with NULLs, but `COUNT(col)` ignores them.
To treat NULL as 0 in sums:
```sql
SELECT SUM(COALESCE(Amount, 0)) FROM Sales;
```

---

### Question 73: Use `CASE` to categorize data into buckets (e.g., age groups).

**Answer:**
```sql
SELECT 
    Name, 
    CASE 
        WHEN Age < 18 THEN 'Minor'
        WHEN Age BETWEEN 18 AND 65 THEN 'Adult'
        ELSE 'Senior' 
    END AS AgeGroup
FROM People;
```

---

### Question 74: Replace NULL values with default values using `COALESCE()`.

**Answer:**
`COALESCE` returns the first non-null value in the list.
```sql
SELECT Product, COALESCE(Description, 'No description available') 
FROM Products;
```

---

### Question 75: How do you clean up bad data (e.g., phone numbers with text)?

**Answer:**
Use `REPLACE` or Regex replacement (`REGEXP_REPLACE`).
**Example:** Remove '-' from phone.
```sql
UPDATE Customers 
SET Phone = REPLACE(Phone, '-', '');
```

---

### Question 76: Write a query to standardize country names.

**Answer:**
```sql
UPDATE Users
SET Country = CASE 
    WHEN Country IN ('USA', 'U.S.A.', 'United States') THEN 'US'
    WHEN Country IN ('UK', 'Great Britain') THEN 'UK'
    ELSE Country
END;
```

---

### Question 77: How do you extract numbers from a string?

**Answer:**
**PostgreSQL:**
```sql
SELECT SUBSTRING('Order #12345', '[0-9]+'); -- '12345'
```

---

### Question 78: Normalize string formats (e.g., capitalize all names).

**Answer:**
Use `UPPER()` or `INITCAP()` (Postgres/Oracle).
```sql
SELECT UPPER(LastName), INITCAP(FirstName) FROM Users;
```

---

### Question 79: Identify and fix inconsistent data (e.g., dates as strings).

**Answer:**
Identify:
```sql
SELECT * FROM Table WHERE ISDATE(StringDate) = 0; -- SQL Server
```
Fix (Cast):
```sql
ALTER TABLE Table ALTER COLUMN DateCol TYPE DATE USING DateCol::DATE;
```

---

### Question 80: Write SQL to de-duplicate based on business rules.

**Answer:**
Similar to Q71, but using business logic (e.g., keep the one with the latest update date).
```sql
WITH Dups AS (
    SELECT ID, 
           ROW_NUMBER() OVER (PARTITION BY Email ORDER BY LastUpdate DESC) as rn
    FROM Customers
)
DELETE FROM Dups WHERE rn > 1;
```

---

## âš« Schema & DDL

### Question 81: How do you create a new table with constraints?

**Answer:**
```sql
CREATE TABLE Employees (
    ID INT PRIMARY KEY,
    Name VARCHAR(100) NOT NULL,
    Email VARCHAR(100) UNIQUE,
    DepartmentID INT,
    FOREIGN KEY (DepartmentID) REFERENCES Departments(ID)
);
```

---

### Question 82: Whatâ€™s the difference between `DELETE`, `TRUNCATE`, and `DROP`?

**Answer:**
*   **`DELETE`**: DML command. Removes rows. Can have `WHERE` clause. Logs every row deleted (slower). Can be rolled back.
*   **`TRUNCATE`**: DDL command. Removes all rows. Resets identity. No `WHERE` clause. Minimal logging (faster). Can't be rolled back (in some DBs).
*   **`DROP`**: DDL command. Removes the entire table structure and data.

---

### Question 83: How do you alter an existing table (add/remove columns)?

**Answer:**
```sql
-- Add
ALTER TABLE Users ADD COLUMN Age INT;

-- Drop
ALTER TABLE Users DROP COLUMN Age;

-- Modify
ALTER TABLE Users ALTER COLUMN Name VARCHAR(200);
```

---

### Question 84: How to enforce referential integrity?

**Answer:**
Use **Foreign Keys**.
```sql
ALTER TABLE Orders 
ADD CONSTRAINT FK_Customer 
FOREIGN KEY (CustomerID) REFERENCES Customers(CustomerID);
```
This ensures an Order cannot exist without a valid Customer.

---

### Question 85: Explain primary key vs unique key.

**Answer:**
*   **Primary Key**: Unique identifier. Cannot be NULL. Only one per table.
*   **Unique Key**: Ensures uniqueness. Can accept NULL (usually one NULL allowed). Multiple allowed per table.

---

### Question 86: What is a composite key?

**Answer:**
A primary key made up of two or more columns.
```sql
CREATE TABLE OrderItems (
    OrderID INT,
    ProductID INT,
    PRIMARY KEY (OrderID, ProductID)
);
```

---

### Question 87: What are views? Pros and cons?

**Answer:**
A **View** is a virtual table based on a SELECT query.
*   **Pros**: Security (hide columns), Simplicity (hide complex joins).
*   **Cons**: Performance (if query is heavy), Maintenance.

---

### Question 88: How do you grant/revoke permissions in SQL?

**Answer:**
```sql
GRANT SELECT, INSERT ON Employees TO UserA;
REVOKE DELETE ON Employees FROM UserA;
```

---

### Question 89: How do you copy schema and data from one table to another?

**Answer:**
**Table and Data:**
```sql
CREATE TABLE NewTable AS SELECT * FROM OldTable;
```
**Structure Only:**
```sql
CREATE TABLE NewTable AS SELECT * FROM OldTable WHERE 1=0;
```

---

### Question 90: What are sequences and auto-increment columns?

**Answer:**
They automatically generate numeric primary keys (`1, 2, 3...`).
*   **SQL Server**: `IDENTITY(1,1)`
*   **Postgres**: `SERIAL` or `CREATE SEQUENCE`
*   **MySQL**: `AUTO_INCREMENT`

---

## ðŸŸ¥ Miscellaneous / Optimization / Troubleshooting

### Question 91: What is SQL injection and how to prevent it?

**Answer:**
Malicious SQL code inserted into inputs.
**Prevention**: Use **Prepared Statements** (Parameterized Queries).
*   Bad: `query = "SELECT * FROM Users WHERE Name = '" + userInput + "'"`
*   Good: `query = "SELECT * FROM Users WHERE Name = ?"; db.execute(query, userInput)`

---

### Question 92: How to handle pagination in SQL?

**Answer:**
Use `LIMIT` and `OFFSET`.
```sql
SELECT * FROM Products 
ORDER BY Price 
LIMIT 10 OFFSET 20; -- Get page 3 (Items 21-30)
```

---

### Question 93: What tools do you use to debug slow SQL queries?

**Answer:**
1.  **EXPLAIN / EXPLAIN ANALYZE**: Execution plan.
2.  **Database Profiler**: SQL Server Profiler, PGAdmin dashboard.
3.  **Slow Query Log**: Logs queries taking > X seconds.

---

### Question 94: When would you use temp tables or table variables?

**Answer:**
*   **Temp Tables (`#Table`)**: Stored in TempDB. Good for large datasets, can be indexed.
*   **Table Variables (`@Table`)**: Stored in memory. Good for small datasets.

---

### Question 95: What is a materialized view?

**Answer:**
A view where the result is physically stored (cached) on disk.
*   **Fast reads.**
*   **Must be refreshed** (manually or periodically) when underlying data changes.

---

### Question 96: Difference between OLTP and OLAP systems?

**Answer:**
*   **OLTP (Online Transaction Processing)**: High volume of small, fast transactions (INSERT/UPDATE). Normalized (3NF). (e.g., Banking app).
*   **OLAP (Online Analytical Processing)**: Complex read queries for analysis. Denormalized (Star Schema). (e.g., BI Dashboard).

---

### Question 97: How do you monitor long-running queries in production?

**Answer:**
Query the active sessions table.
**Postgres:** `pg_stat_activity`
**SQL Server:** `sp_who2` or `sys.dm_exec_requests`

---

### Question 98: Explain batch vs streaming queries.

**Answer:**
*   **Batch**: Process a fixed set of data at intervals (e.g., Nightly ETL).
*   **Streaming**: Process data rows essentially in real-time as they arrive (e.g., Kafka -> KSQL).

---

### Question 99: What is sharding and partitioning in SQL databases?

**Answer:**
*   **Partitioning**: Splitting a large table into smaller chunks within the **same** database server (e.g., by Year).
*   **Sharding**: Distributing data across **multiple** servers (horizontal scaling).

---

### Question 100: How do you migrate large amounts of data efficiently using SQL?

**Answer:**
1.  **Batching**: Move data in chunks (e.g., 1000 rows at a time) to avoid transaction log overflow.
2.  **Disable Indexes**: Drop indexes on target, load data, recreate indexes.
3.  **Bulk Insert**: Use tools like `COPY` (Postgres) or `BULK INSERT` (SQL Server) instead of standard inserts.
